# Schedy-project
Team project
# Schedy — проект персонального планировщика и ассистента

**Schedy** — это гибридное приложение для планирования задач и событий, реализованное как Telegram-бот с сопутствующим веб-интерфейсом. Проект позволяет управлять списком задач, календарными событиями и напоминаниями через Telegram (включая встроенное Web-приложение Telegram). Поддерживается интеграция с внешними календарями (Google, Outlook), хранение аудиозаписей (Voice Log) и функциональность платежей (создание счетов для донатов). Проект сочетает клиентскую часть на React (Telegram Web App) и серверную часть на Python (FastAPI + Aiogram), что обеспечивает удобное взаимодействие пользователя с ботом и надёжное хранение данных.

## Назначение и описание проекта

Schedy служит для персонального тайм-менеджмента и планирования. Он позволяет:

* Создавать, просматривать и редактировать **задачи** и **события расписания** (`ScheduleEvent`) с указанием времени начала и окончания.
* Устанавливать **напоминания** (`Reminder`) для задач или событий.
* Интегрировать внешний календарь: хранить токены доступа к Google/Outlook (модель `OAuthToken`) и синхронизировать внешние события (модель `SyncedEvent`).
* Хранить **аудиозаписи** (VoiceLog) — например, для будущей обработки голосовых команд (инфраструктура заложена в БД).
* Обслуживать платежи — создавать счет для доната через Telegram (см. endpoint `/api/donate` и метод `CreateInvoiceLink` в коде).
* Предоставлять информацию о текущем пользователе через API (`/api/users/get` возвращает объект пользователя).
* Обеспечивать взаимодействие как через **Telegram Bot** (сообщения, команды, встроенные клавиатуры), так и через **веб-интерфейс** (Telegram Web App на React). Приложение разделено на клиентскую и серверную части, которые обмениваются данными по HTTP API.

## Используемые технологии, библиотеки и архитектура

* **Языки и фреймворки**:

  * **Frontend**: React с TypeScript, Vite, Tailwind CSS, библиотека `@telegram-apps/sdk` для Telegram Web App, `@tanstack/react-query` для управления данными, Axios для HTTP-запросов.
  * **Backend**: Python 3.13+, [FastAPI](https://fastapi.tiangolo.com/) для REST API, [Aiogram](https://docs.aiogram.dev/) для Telegram-бота, [Tortoise ORM](https://tortoise-orm.readthedocs.io/) (с [Aerich](https://github.com/tortoise/aerich)) для работы с БД, [Uvicorn](https://www.uvicorn.org/) как ASGI-сервер.
* **База данных**: PostgreSQL (используется `asyncpg`). Модели данных описаны через Tortoise ORM (`db/models/*.py`).
* **Интеграции**: OAuth для внешних календарей, Telegram Payments API (инвойсы).
* **Архитектура**: Разделение на *клиент* и *сервер* в одном репозитории. Клиент собирается отдельно и обращается к серверу по HTTP. Серверная часть включает два режима:

  * Web API (FastAPI) — обрабатывает HTTP-запросы и Telegram-webhook (`/webhook`, `/api/*`).
  * Telegram-поллинг (скрипт `bot_runner.py`) — запуская бота через polling.
* **Конфигурация**: Параметры (BOT\_TOKEN, DB\_URL, URL вебхука и т.д.) задаются через переменные окружения (Pydantic `BaseSettings` в `config_reader.py`).

## Установка, настройка и запуск

### Системные требования

* Python 3.13 или новее
* PostgreSQL (или другая совместимая СУБД)
* Node.js (рекомендуется v18+)

1. **Склонируйте репозиторий** и перейдите в корневой каталог проекта:

   ```bash
   git clone <URL_репозитория>
   cd Schedy-project
   ```

2. **Настройка серверной части (Python)**:

   * Перейдите в папку сервера и убедитесь, что установлен Python 3.13+ и Poetry или pip:

     ```bash
     cd server
     ```
   * Создайте файл `.env` с необходимыми переменными. Например:

     ```dotenv
     BOT_TOKEN=<ваш_токен_бота_Telegram>
     DB_URL=postgres://user:password@localhost:5432/yourdbname
     WEBHOOK_URL=https://your-domain.com  # URL для вебхука Telegram (если используется)
     WEBAPP_URL=https://<ваш_ngrok>.app  # URL веб-приложения Telegram (для авторизации Web App)
     APP_HOST=localhost  # хост FastAPI
     APP_PORT=8080       # порт FastAPI
     ```
   * Установите зависимости Python:

     ```bash
     poetry install
     ```

     или, при наличии `requirements.txt`:

     ```bash
     pip install -r requirements.txt
     ```
   * Выполните миграции Aerich для создания схемы БД:

     ```bash
     aerich init -t config_reader.TORTOISE_ORM   # если ещё не инициализировано
     aerich migrate --name init
     aerich upgrade
     ```

3. **Запуск сервера и бота**:

   * Для работы Telegram-бота запустите скрипт поллинга:

     ```bash
     python bot_runner.py
     ```
   * Для запуска FastAPI (API-сервера и вебхука) используйте Uvicorn:

     ```bash
     uvicorn __main__:app --reload --host localhost --port 8080
     ```
   * Убедитесь, что в `.env` указаны корректные адреса и Telegram-бот настроен на тот же `WEBHOOK_URL` (если используется вебхук).

4. **Клиентская часть (Telegram Web App)**:

   * Установите Node.js и перейдите в папку клиента:

     ```bash
     cd ../client
     npm install
     ```
   * Создайте `.env` файл с адресом сервера:

     ```dotenv
     VITE_API_URL=http://localhost:8080
     ```
   * Запустите dev-сервер или сборку:

     ```bash
     npm run dev     # режим разработки (hot-reload)
     npm run build   # сборка для продакшена
     ```
   * В Telegram запустите бот и откройте Web App. Клиент загрузится в интерфейсе Telegram и выполнит запросы к API (см. `App.tsx` для примера).

## Примеры использования

* **Взаимодействие с ботом**: Пользователь вводит команды или нажимает кнопки (например `/start` для начала). Обработчики команд находятся в `handlers/common.py` и `handlers/layerToggle.py` (навигация по календарю, переключение экранов).
* **Запрос информации о пользователе**: Web App при инициализации делает GET-запрос к `/api/users/get` с заголовком `initData` Telegram. Ответ содержит данные пользователя (`UserSchema`), например `{ "user": { "telegram_id": 123456789, "timezone": "UTC", ... } }`.
* **Создание доната**: Посылая POST на `/api/donate` с телом `{"amount": 1000}`, сервер возвращает ссылку для оплаты (используется метод `CreateInvoiceLink` с валютой XTR).
* **Пример ответа**: Запрос к `/api/users/get` может вернуть JSON:

  ```json
  {
    "user": {
      "id": 1,
      "telegram_id": 123456789,
      "timezone": "UTC",
      "locale": "ru-RU",
      "created_at": "2024-10-01T12:34:56"
    }
  }
  ```
* **Структура данных**: Модели Pydantic (например, `ScheduleEventSchema`) используются для сериализации объектов БД (см. `db/models/*.py`).
* **Локальный сценарий**: После запуска FastAPI (`http://localhost:8080`) и бота, пользователь открывает бота в Telegram и загружает Web App. Приложение отображает информацию о пользователе и интерфейс для планирования. Пользователь может добавлять задачи/события через UI, которые сохраняются в базу данных через соответствующие API-вызовы.

## Возможные сценарии применения

* **Научный/учебный контекст**: Помощь студентам и исследователям в планировании экспериментов, семинаров и дедлайнов. Отправка напоминаний о важных датах, интеграция с Google Calendar.
* **Коммерческий продукт**: Чат-бот для управления задачами команды внутри организации, интегрированный в мессенджер. Поддержка донатов через Telegram и сбор аналитики (логи голосовых команд, аудита).
* **Технический пример**: Демонстрация современной связки технологий: Telegram Bot API, веб-приложение на React, асинхронный Python/FastAPI, ORM с миграциями. Может служить шаблоном для гибридных «бот + веб» решений.
* **Личное планирование**: Пользователь ведёт список личных дел и событий, синхронизирует их с внешними календарями и управляет ими из любого устройства через Telegram.
* **Голосовой помощник**: Архитектура готова для добавления функций распознавания речи (VoiceLog сохраняет аудио и тексты, которые можно использовать в NLU-сервисах).

## Структура проекта

```bash
Schedy-project/
├── client/                 # Клиент (React + Telegram Web App)
│   ├── public/             # Статические файлы (HTML, скрипты)
│   ├── src/                # Исходный код React (компоненты, страницы, утилиты)
│   │   ├── App.tsx         # Главный React-компонент (запрашивает профиль пользователя)
│   │   ├── components/     # UI-компоненты (карты задач, меню и т.д.)
│   │   ├── interfaces/     # TypeScript-интерфейсы (IUser и др.)
│   │   ├── pages/          # Страницы приложения (календарь, настройки и др.)
│   │   └── utils/api.ts    # Axios-обёртка для API (добавляет initData заголовок)
│   ├── package.json        # Зависимости npm для фронтенда
│   └── vite.config.ts      # Конфигурация сборки Vite
└── server/                 # Сервер (FastAPI + Telegram Bot)
    ├── api/                # REST API (FastAPI роутеры)
    │   ├── common.py       # Webhook и endpoint /api/donate
    │   ├── users.py        # Endpoint /api/users
    │   └── utils.py        # Функции авторизации Web App, проверка пользователя
    ├── db/
    │   ├── models/         # Модели Tortoise (User, Task, ScheduleEvent, OAuthToken, и др.)
    │   └── migrations/     # Скрипты миграций Aerich
    ├── handlers/           # Обработчики Telegram-бота (команды, callback, FSM)
    │   ├── common.py       # Основные команды (/start, календарь)
    │   ├── layerToggle.py  # Логика переключения экранов бота (дом, календарь, настройки)
    │   ├── schedule.py     # Навигация по неделям календаря
    │   └── __init__.py     # Регистрация роутеров бота
    ├── keyboards/          # Сборка inline-клавиатур для бота
    ├── config_reader.py    # Загрузка настроек (BOT_TOKEN, DB_URL) и инициализация FastAPI и бота
    ├── bot_runner.py       # Запуск Telegram-бота в режиме polling
    ├── __main__.py        # Точка входа FastAPI (uvicorn)
    ├── pyproject.toml     # Конфигурация Python-проекта (Poetry)
    └── poetry.lock        # Зафиксированные версии Python-зависимостей
```
